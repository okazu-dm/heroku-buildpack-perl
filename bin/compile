#!/bin/sh

indent() {
  sed -u 's/^/       /'
}

BUILD_DIR=$1
CACHE_DIR=$2

PERL_VERSION=5.20.1
RELEASE_VERSION=0.5
PERL_PACKAGE=https://github.com/shoichikaji/relocatable-perl/releases/download/$RELEASE_VERSION/perl-v$PERL_VERSION-x86_64-linux.tar.gz

rm -rf $BUILD_DIR/vendor
if [ -d $CACHE_DIR/vendor ]; then
  cp -a $CACHE_DIR/vendor $BUILD_DIR/vendor
else
  echo "-----> Vendoring Perl"
  mkdir -p $BUILD_DIR/vendor && curl -sL $PERL_PACKAGE | tar xzf - --strip-components 1 -C $BUILD_DIR/vendor
fi

export PATH="$BUILD_DIR/vendor/bin:$PATH"
export PERL_CPANM_OPT="--quiet --notest"

cd $BUILD_DIR

echo "-----> Installing dependencies"
cpanm --installdeps . 2>&1 | indent

echo "-----> Installing Starman"
cpanm Starman 2>&1 | indent

change-shebang -f $BUILD_DIR/vendor/bin/*

if [ -d $BUILD_DIR/vendor ]; then
  rm -rf $CACHE_DIR/vendor
  mkdir -p $CACHE_DIR
  cp -a $BUILD_DIR/vendor $CACHE_DIR/vendor
fi
